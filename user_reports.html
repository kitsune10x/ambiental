<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meus Reportes — Nosso Projeto</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a class="logo" href="index.html" aria-label="Ir para a página inicial">
          <strong>De Olho No Lixo</strong>
          <span class="tag">Relatórios enviados por você</span>
        </a>
      </div>
      <nav class="actions">
        <button onclick="history.back()" class="btn">Voltar</button>
        <button id="reportsThemeToggle" class="theme-toggle" aria-pressed="false" aria-label="Alternar tema" style="margin-left:10px;">
          <span class="icon moon" aria-hidden="true">🌙</span>
          <span class="icon sun" aria-hidden="true">☀️</span>
          <span class="sr-only">Alternar tema</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:20px;">
    <section>
      <h2>Seus reportes recentes</h2>
      <p class="muted">Aqui estão os reportes enviados por você — você pode ver, editar ou remover cada item.</p>
      <div id="myReportsList" style="margin-top:12px;display:flex;flex-direction:column;gap:12px;"></div>
      <div id="noMyReports" class="muted" style="margin-top:12px;display:none;">Você não tem reportes registrados.</div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container"><p>&copy; <span id="year"></span> Nosso Projeto — Meus Reportes</p></div>
  </footer>

  <div id="confirmOverlay" class="modal" aria-hidden="true" style="backdrop-filter: blur(4px);">
    <div class="modal-panel" role="dialog" aria-modal="true" style="max-width:360px;text-align:center;">
      <div style="font-weight:700;margin-bottom:8px;">Remover reporte</div>
      <div id="confirmMsg" style="margin-bottom:14px;color:var(--muted)">Deseja realmente remover este reporte?</div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirmYesBtn" class="btn primary">Sim</button>
        <button id="confirmNoBtn" class="btn ghost">Não</button>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle for Meus Reportes page (persisted)
    (function(){
      const toggle = document.getElementById('reportsThemeToggle');
      function setTheme(isDark){
        document.body.classList.toggle('dark', isDark);
        toggle.setAttribute('aria-pressed', String(isDark));
        localStorage.setItem('darkMode', isDark ? '1' : '0');
      }
      setTheme(localStorage.getItem('darkMode') === '1');
      toggle.addEventListener('click', ()=> setTheme(!document.body.classList.contains('dark')));
    })();
    
    document.getElementById('year').textContent = new Date().getFullYear();
    const listEl = document.getElementById('myReportsList');
    const noEl = document.getElementById('noMyReports');
    const overlay = document.getElementById('confirmOverlay');
    const yesBtn = document.getElementById('confirmYesBtn');
    const noBtn = document.getElementById('confirmNoBtn');
    let pendingCreated = null;

    function translateLevel(level){
      return level === 'low' ? 'Alerta baixo' : level === 'medium' ? 'Alerta médio' : level === 'high' ? 'Alerta alto' : level === 'critical' ? 'Alerta máximo' : (level || '—');
    }

    function getCurrentUser(){
      return JSON.parse(localStorage.getItem('currentUser')||'null') || {};
    }

    function render(){
      const cur = getCurrentUser();
      const reports = JSON.parse(localStorage.getItem('reports')||'[]').slice().reverse();
      const mine = reports.filter(r => (r.reporter === cur.name || r.reporter === cur.email || (r.email && r.email === cur.email)));
      listEl.innerHTML = '';
      if(!mine.length){
        noEl.style.display = 'block';
        return;
      }
      noEl.style.display = 'none';
      mine.forEach(r=>{
        const created = r.created ? new Date(r.created) : new Date();
        const node = document.createElement('div');
        node.className = 'floating-notice';
        node.dataset.created = created.getTime();
        node.style.display = 'flex';
        node.style.justifyContent = 'space-between';
        node.style.alignItems = 'center';
        node.style.padding = '12px';
        node.style.borderRadius = '8px';
        node.innerHTML = `<div style="flex:1">
            <div style="font-size:0.9rem;color:var(--muted);margin-bottom:6px">Você</div>
            <div style="font-weight:700">${r.type || 'Reporte'}</div>
            <div class="muted" style="font-size:0.88rem;margin-top:6px">${translateLevel(r.alertLevel)} • ${created.toLocaleDateString()} • ${created.toLocaleTimeString()}</div>
            <div style="margin-top:8px;color:var(--muted)">${r.desc || ''}</div>
            <div style="margin-top:6px;font-size:0.85rem;color:var(--muted)">${r.lat && r.lng ? `Coordenadas: ${r.lat}, ${r.lng}` : ''}</div>
          </div>
          <div style="margin-left:12px;text-align:right;display:flex;flex-direction:column;gap:6px">
            <button class="btn tiny view-report">Ver</button>
            <button class="btn tiny edit-report">Editar</button>
            <button class="btn tiny remove-report">Remover</button>
          </div>`;
        listEl.appendChild(node);

        node.querySelector('.view-report').addEventListener('click', ()=> {
          alert(`${r.type || 'Reporte'}\n\n${r.desc || ''}\n\n${created.toLocaleString()}\n${r.lat && r.lng ? 'Coordenadas: '+r.lat+', '+r.lng : ''}`);
        });

        node.querySelector('.edit-report').addEventListener('click', ()=>{
          const newDesc = prompt('Editar descrição do reporte:', r.desc || '');
          if(newDesc === null) return;
          r.desc = newDesc.trim();
          const newLevel = prompt('Nível de alerta (low, medium, high, critical):', r.alertLevel || '');
          if(newLevel !== null && ['low','medium','high','critical'].includes(newLevel.trim())) r.alertLevel = newLevel.trim();
          // update in storage by matching created timestamp
          const all = JSON.parse(localStorage.getItem('reports')||'[]');
          const idx = all.findIndex(rr => (rr.created ? new Date(rr.created).getTime() : null) === Number(node.dataset.created));
          if(idx !== -1){ all[idx] = r; localStorage.setItem('reports', JSON.stringify(all)); render(); }
        });

        node.querySelector('.remove-report').addEventListener('click', ()=>{
          pendingCreated = node.dataset.created;
          overlay.setAttribute('aria-hidden','false');
          yesBtn.focus();
        });
      });
    }

    yesBtn.addEventListener('click', ()=>{
      if(!pendingCreated) return closeOverlay();
      const reports = JSON.parse(localStorage.getItem('reports')||'[]');
      const filtered = reports.filter(r => {
        const ts = r.created ? new Date(r.created).getTime() : null;
        return ts !== Number(pendingCreated);
      });
      localStorage.setItem('reports', JSON.stringify(filtered));
      pendingCreated = null;
      overlay.setAttribute('aria-hidden','true');
      render();
    });
    noBtn.addEventListener('click', ()=> { pendingCreated = null; overlay.setAttribute('aria-hidden','true'); });
    overlay.addEventListener('click', (e)=> { if(e.target === overlay) { pendingCreated = null; overlay.setAttribute('aria-hidden','true'); } });

    // color/age update (visual) similar to avisos page
    function ageUpdate(){
      Array.from(listEl.children).forEach(node=>{
        const created = Number(node.dataset.created) || Date.now();
        const age = Date.now() - created;
        const p = Math.min(1, Math.max(0, age / (60*60*1000)));
        const hue = Math.round(120 - (120 * p));
        node.style.background = `linear-gradient(90deg, hsl(${hue} 70% 90%) 0%, rgba(255,255,255,0) 100%)`;
        node.style.border = `1px solid hsl(${hue} 60% 75%)`;
        node.style.opacity = age >= 60*60*1000 ? '0.6' : '1';
      });
    }

    render();
    setInterval(ageUpdate, 1000);
    window.addEventListener('storage', (e)=> { if(e.key === 'reports' || e.key === 'currentUser') render(); });
  </script>
</body>
</html>