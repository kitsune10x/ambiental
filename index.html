<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Avisos ‚Äî Reportes</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a class="logo" href="../index.html"><strong>De Olho No Lixo</strong><span class="tag">Lista de reportes enviados (compartilhado)</span></a>
      </div>
      <nav class="actions">
        <button onclick="history.back()" class="btn">Voltar</button>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:20px;">
    <section>
      <h2>Reportes recentes</h2>
      <div id="avisosList" style="margin-top:12px;display:flex;flex-direction:column;gap:12px;"></div>
      <div id="noAvisos" class="muted" style="margin-top:12px;display:none;">Nenhum reporte encontrado.</div>
    </section>

    <!-- Conclu√≠dos -->
    <section style="margin-top:18px;">
      <h3>Conclu√≠dos</h3>
      <div id="concludedSection" style="margin-top:8px;">
        <div id="concludedList" class="muted" style="max-height:220px;overflow:auto;">Nenhum registro conclu√≠do.</div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container"><p>&copy; <span id="year"></span> Nosso Projeto ‚Äî Avisos</p></div>
  </footer>

  <!-- Confirmation modal for removals -->
  <div id="confirmOverlay" class="modal" aria-hidden="true" style="backdrop-filter: blur(4px);">
    <div class="modal-panel" role="dialog" aria-modal="true" style="max-width:360px;text-align:center;">
      <div style="font-weight:700;margin-bottom:8px;">Confirmar a den√∫ncia?</div>
      <div id="confirmMsg" style="margin-bottom:14px;color:var(--muted)">Voc√™ realmente deseja denunciar esse reporte?</div>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="confirmYesBtn" class="btn primary">Sim</button>
        <button id="confirmNoBtn" class="btn ghost">N√£o</button>
      </div>
    </div>
  </div>

  <!-- Green translucent overlay shown when a report is concluded -->
  <div id="concludedOverlay" class="success-overlay" aria-hidden="true" style="background: rgba(34, 139, 34, 0.12);">
    <div class="success-card" role="dialog" aria-modal="true" style="background: rgba(34, 139, 34, 0.95);">
      <h3 style="margin:0;color:white;">Reporte conclu√≠do</h3>
      <p style="color:rgba(255,255,255,0.95);margin-top:8px;">Esse reporte foi conclu√≠do.</p>
      <button id="closeConcluded" class="btn" style="margin-top:12px;">Fechar</button>
    </div>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    function render(){
      const listEl = document.getElementById('avisosList');
      // only show non-concluded reports in the "Reportes recentes" list
      const reports = JSON.parse(localStorage.getItem('reports')||'[]').slice().reverse().filter(r => !r.concluded);
      listEl.innerHTML = '';
      if(!reports.length){
        document.getElementById('noAvisos').style.display = 'block';
        return;
      }
      document.getElementById('noAvisos').style.display = 'none';
      reports.forEach(r=>{
        const created = r.created ? new Date(r.created) : new Date();
        // prefer explicit reporter field (saved at submit), fallback to sensible values (no "An√¥nimo")
        const reporter = r.user || r.name || r.reporter || r.email || 'mathias';
        const node = document.createElement('div');
        node.className = 'floating-notice';
        node.dataset.created = created.getTime();
        node.style.display = 'flex';
        node.style.justifyContent = 'space-between';
        node.style.alignItems = 'center';
        node.style.padding = '12px';
        node.style.borderRadius = '8px';
        node.innerHTML = `<div style="flex:1">
            <div style="font-size:0.9rem;color:var(--muted);margin-bottom:6px">${reporter}</div>
            <div style="font-weight:700">${r.type || 'Reporte'}</div>
            <div class="muted" style="font-size:0.88rem;margin-top:6px">${translateLevel(r.alertLevel)} ‚Ä¢ ${created.toLocaleDateString()} ‚Ä¢ ${created.toLocaleTimeString()}</div>
            <div style="margin-top:8px;color:var(--muted)">${r.desc || ''}</div>
            <div style="margin-top:6px;font-size:0.85rem;color:var(--muted)">${r.lat && r.lng ? `Coordenadas: ${r.lat}, ${r.lng}` : ''}</div>
          </div>
          <div style="margin-left:12px;text-align:right">
            <div style="font-size:0.85rem;color:var(--muted)">${created.toLocaleString()}</div>
          </div>`;
        node.addEventListener('click', ()=> {
          // quick inspect
          alert(`${r.type || 'Reporte'}\n\n${r.desc || ''}\n\n${created.toLocaleString()}${r.lat && r.lng ? '\nCoordenadas: ' + r.lat + ', ' + r.lng : ''}`);
        });
        listEl.appendChild(node);
      });
    }

    function translateLevel(level){
      return level === 'low' ? 'Alerta baixo' : level === 'medium' ? 'Alerta m√©dio' : level === 'high' ? 'Alerta alto' : level === 'critical' ? 'Alerta m√°ximo' : (level || '‚Äî');
    }

    // render concluded reports (those with concluded: true)
    function renderConcluded(){
      const el = document.getElementById('concludedList');
      const reports = JSON.parse(localStorage.getItem('reports')||'[]').slice().reverse();
      const concluded = reports.filter(r=> r.concluded);
      if(!concluded.length){ el.innerHTML = '<div class="muted">Nenhum registro conclu√≠do.</div>'; return; }
      el.innerHTML = '';
      concluded.forEach(r=>{
        const created = r.concludedAt ? new Date(r.concludedAt) : (r.created ? new Date(r.created) : new Date());
        const node = document.createElement('div');
        node.className = 'floating-notice';
        node.style.padding = '10px'; node.style.borderRadius = '8px'; node.style.marginBottom = '8px';
        node.innerHTML = `<div style="font-weight:700">${r.type || 'Reporte'}</div><div class="muted" style="font-size:0.9rem">${translateLevel(r.alertLevel)} ‚Ä¢ ${created.toLocaleString()}</div><div style="margin-top:6px;color:var(--muted)">${r.desc || ''}</div>`;
        el.appendChild(node);
      });
    }

    render();
    renderConcluded();
    // react to storage changes (when user reports)
    window.addEventListener('storage', (e)=> { if(e.key === 'reports') { render(); renderConcluded(); } });
  </script>

  <script>
    (function(){
      const listEl = document.getElementById('avisosList');
      // used to track which report action is pending (created timestamp)
      const overlay = document.getElementById('confirmOverlay');
      const yesBtn = document.getElementById('confirmYesBtn');
      const noBtn = document.getElementById('confirmNoBtn');
      let pendingCreated = null;

      function openConfirm(created, node){
        pendingCreated = created;
        overlay.setAttribute('aria-hidden','false');
        // trap focus briefly
        yesBtn.focus();
      }
      function closeConfirm(){
        pendingCreated = null;
        overlay.setAttribute('aria-hidden','true');
      }

      function enhance(){
        Array.from(listEl.children).forEach(node=>{
          if(node.dataset.enhanced) return; node.dataset.enhanced = '1';
          const created = Number(node.dataset.created) || Date.now();
          // add controls
          const ctrl = document.createElement('div'); ctrl.style.marginTop='8px';
          // speaker/report flag button (den√∫ncia)
          const speaker = document.createElement('button');
          speaker.className = 'btn tiny';
          speaker.title = 'Denunciar reporte';
          speaker.style.background = '#ffecec';
          speaker.style.color = '#c0392b';
          speaker.style.border = '1px solid rgba(0,0,0,0.04)';
          speaker.style.padding = '6px';
          speaker.style.borderRadius = '6px';
          speaker.style.marginRight = '6px';
          speaker.innerHTML = 'üîä';
          // conclude button (previously "Remover")
          const del = document.createElement('button'); del.textContent='Concluir'; del.className='btn tiny';
          ctrl.appendChild(del);
          ctrl.insertBefore(speaker, del);
          node.querySelector('div')?.appendChild(ctrl);

          // conclude action (previously "Remover")
          del.addEventListener('click', ()=>{
            // mark report as concluded and persist
            const reports = JSON.parse(localStorage.getItem('reports')||'[]');
            const idx = reports.findIndex(rr => (rr.created ? new Date(rr.created).getTime() : null) === Number(node.dataset.created));
            if(idx !== -1){
              reports[idx].concluded = true;
              reports[idx].concludedAt = new Date().toISOString();
              localStorage.setItem('reports', JSON.stringify(reports));
            }
            // visual feedback and refresh lists
            node.style.opacity = '0.6';
            node.style.filter = 'grayscale(40%)';
            if(!node.querySelector('.done-badge')) {
              const b = document.createElement('span'); b.className='done-badge'; b.textContent='Conclu√≠do'; b.style.fontSize='0.8rem'; b.style.marginLeft='8px'; b.style.color='var(--muted)';
              node.querySelector('div').firstElementChild?.appendChild(b);
            }
            render();
            renderConcluded();
            // show green translucent concluded overlay
            const conclOverlay = document.getElementById('concludedOverlay');
            if(conclOverlay){
              conclOverlay.setAttribute('aria-hidden','false');
              document.getElementById('closeConcluded').focus();
            }
          });

          // speaker opens the denuncia confirm and will remove the report if confirmed
          speaker.addEventListener('click', ()=>{
            openConfirm(created, node);
          });
        });
      }

      // handle confirm actions
      yesBtn.addEventListener('click', ()=>{
        if(!pendingCreated) return closeConfirm();
        // remove the report from localStorage by matching its created timestamp (den√∫ncia confirmed)
        const reports = JSON.parse(localStorage.getItem('reports')||'[]');
        const filtered = reports.filter(r => {
          const ts = r.created ? new Date(r.created).getTime() : null;
          return ts !== Number(pendingCreated);
        });
        localStorage.setItem('reports', JSON.stringify(filtered));
        // re-render the list in this page and close confirm
        render();
        // ensure per-item controls (Remover / Escrever) remain after deletion
        if(typeof enhance === 'function') try{ enhance(); }catch(e){/* ignore */ }
        closeConfirm();
      });
      noBtn.addEventListener('click', closeConfirm);
      // close when clicking overlay background
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeConfirm(); });

      // concluded overlay close handler
      const concludedOverlayEl = document.getElementById('concludedOverlay');
      const closeConcludedBtn = document.getElementById('closeConcluded');
      if(closeConcludedBtn && concludedOverlayEl){
        closeConcludedBtn.addEventListener('click', ()=> concludedOverlayEl.setAttribute('aria-hidden','true'));
        concludedOverlayEl.addEventListener('click', (e)=> { if(e.target === concludedOverlayEl) concludedOverlayEl.setAttribute('aria-hidden','true'); });
      }

      function ageUpdate(){
        Array.from(listEl.children).forEach(node=>{
          const created = Number(node.dataset.created) || Date.now();
          const age = Date.now() - created;
          const p = Math.min(1, Math.max(0, age / (60*60*1000)));
          const hue = Math.round(120 - (120 * p));
          node.style.background = `linear-gradient(90deg, hsl(${hue} 70% 90%) 0%, rgba(255,255,255,0) 100%)`;
          node.style.border = `1px solid hsl(${hue} 60% 75%)`;
          const expired = age >= 60*60*1000;
          node.style.opacity = expired ? '0.6' : '1';
        });
      }
      // run after initial render and on storage changes
      setTimeout(()=>{ enhance(); ageUpdate(); }, 200);
      window.addEventListener('storage', (e)=> { if(e.key === 'reports') { setTimeout(()=>{ render(); enhance(); ageUpdate(); },100); }});
      setInterval(ageUpdate,1000);
    })();
  </script>
</body>
</html>