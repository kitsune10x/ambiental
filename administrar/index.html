<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Administrar ‚Äî Nosso Projeto</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* small page-specific styles */
    .team-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:16px}
    .person{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:var(--card-bg);border:1px solid rgba(0,0,0,0.04)}
    .avatar-circle{width:56px;height:56px;border-radius:50%;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;font-size:1.4rem;background:color-mix(in srgb,var(--card-bg) 88%, transparent);border:2px solid rgba(0,0,0,0.04)}
    .person .meta{display:flex;flex-direction:column}
    .role{font-size:0.85rem;color:var(--muted)}
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle;box-shadow:0 1px 2px rgba(0,0,0,0.08)}
    .online{background:#28a745}
    .offline{background:#c0392b}
    .filter-bar{display:flex;gap:8px;align-items:center;margin-top:12px}
    @media (max-width:700px){ .person{padding:8px} .avatar-circle{width:48px;height:48px} }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <a class="logo" href="../index.html"><strong>De Olho No Lixo</strong><span class="tag">Administra√ß√£o de usu√°rios</span></a>
      </div>
      <nav class="actions">
        <button onclick="history.back()" class="btn">Voltar</button>
        <button id="adminThemeToggle" class="theme-toggle" aria-pressed="false" aria-label="Alternar tema" style="margin-left:10px;">
          <span class="icon moon" aria-hidden="true">üåô</span>
          <span class="icon sun" aria-hidden="true">‚òÄÔ∏è</span>
          <span class="sr-only">Alternar tema</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:20px;">
    <h2>Administrar ‚Äî Trabalhadores e Gerentes</h2>
    <p class="muted">Lista fict√≠cia de contas com status online/offline indicados por um ponto verde (online) ou vermelho (offline).</p>

    <div class="filter-bar">
      <label style="display:flex;align-items:center;gap:8px">
        Mostrar:
        <select id="filterSelect" class="btn" style="padding:6px;border-radius:8px;">
          <option value="all">Todos</option>
          <option value="workers">Trabalhadores</option>
          <option value="managers">Gerentes</option>
          <option value="online">Apenas online</option>
        </select>
      </label>
      <button id="refreshList" class="btn ghost">Atualizar</button>
    </div>

    <section style="margin-top:12px;">
      <h3>Gerentes</h3>
      <div id="managersGrid" class="team-grid" aria-live="polite"></div>
    </section>

    <section style="margin-top:18px;">
      <h3>Trabalhadores</h3>
      <div id="workersGrid" class="team-grid" aria-live="polite"></div>
    </section>
  </main>

  <!-- Chat modal for conversations -->
  <div id="chatModal" class="modal" aria-hidden="true">
    <div class="modal-panel" style="max-width:520px;">
      <button class="modal-close" id="closeChat" aria-label="Fechar">&times;</button>
      <h4 id="chatTitle">Conversa</h4>
      <div id="chatBody" style="max-height:300px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <input id="chatInput" type="text" placeholder="Escrever mensagem..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e6e6" />
        <button id="chatSend" class="btn primary">Enviar</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container"><p>&copy; <span id="year"></span> Nosso Projeto ‚Äî Administrar</p></div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // fictitious profiles (names, role, avatar emoji fallback, online boolean)
    const profiles = [
      {name:'Ana Souza', role:'manager', avatar:'üë©‚Äçüíº', online:true},
      {name:'Vinicius Ramos', role:'manager', avatar:'üë®‚Äçüíº', online:false},
      {name:'Carla Mendes', role:'worker', avatar:'üë©‚Äçüåæ', online:true},
      {name:'Jo√£o Pereira', role:'worker', avatar:'üë®‚Äçüîß', online:false},
      {name:'Mariana Lima', role:'worker', avatar:'üë©‚Äçüî¨', online:true},
      {name:'Rog√©rio Alves', role:'worker', avatar:'üë®‚Äçüåæ', online:false},
      {name:'Beatriz Costa', role:'manager', avatar:'üë©‚Äçüíª', online:true},
      {name:'Felipe Rocha', role:'worker', avatar:'üë®‚Äçüîß', online:false},
      {name:'Sofia Ara√∫jo', role:'worker', avatar:'üë©‚Äçüéì', online:true}
    ];

    function createPersonNode(p){
      const div = document.createElement('div');
      div.className = 'person';
      div.dataset.role = p.role;
      div.dataset.online = p.online ? '1' : '0';
      const avatar = document.createElement('div');
      avatar.className = 'avatar-circle';
      // render a neutral default avatar using initials (no emoji)
      const initials = (p.name||'').split(' ').filter(Boolean).map(n=>n[0]).slice(0,2).join('').toUpperCase() || 'US';
      avatar.textContent = initials;
      const meta = document.createElement('div');
      meta.className = 'meta';
      const top = document.createElement('div');
      top.innerHTML = `<strong>${p.name}</strong><span class="status-dot ${p.online ? 'online' : 'offline'}" title="${p.online ? 'Online' : 'Offline'}" aria-hidden="true"></span>
        <button class="btn tiny msg-btn" title="Abrir conversa" style="margin-left:8px;">‚úâÔ∏è</button>`;
      const bottom = document.createElement('div');
      bottom.className = 'role';
      bottom.textContent = p.role === 'manager' ? 'Gerente' : 'Trabalhador';
      meta.appendChild(top); meta.appendChild(bottom);
      div.appendChild(avatar); div.appendChild(meta);
      return div;
    }

    function renderList(filter = 'all'){
      const mgr = document.getElementById('managersGrid');
      const wk = document.getElementById('workersGrid');
      mgr.innerHTML = ''; wk.innerHTML = '';
      let list = profiles.slice();
      if(filter === 'online') list = list.filter(p => p.online);
      else if(filter === 'workers') list = list.filter(p => p.role === 'worker');
      else if(filter === 'managers') list = list.filter(p => p.role === 'manager');
      list.forEach(p => {
        const node = createPersonNode(p);
        if(p.role === 'manager') mgr.appendChild(node); else wk.appendChild(node);
      });
      if(mgr.children.length === 0) mgr.innerHTML = '<div class="muted">Nenhum gerente encontrado.</div>';
      if(wk.children.length === 0) wk.innerHTML = '<div class="muted">Nenhum trabalhador encontrado.</div>';
    }

    document.getElementById('filterSelect').addEventListener('change', (e)=> renderList(e.target.value));
    document.getElementById('refreshList').addEventListener('click', ()=> {
      // simulate small random online state changes for demo refresh
      profiles.forEach(p => { if(Math.random() < 0.2) p.online = !p.online; });
      renderList(document.getElementById('filterSelect').value);
    });

    // initial render
    renderList('all');

    // theme toggle (consistent with other pages)
    (function(){
      const toggle = document.getElementById('adminThemeToggle');
      if(!toggle) return;
      function setTheme(isDark){
        document.body.classList.toggle('dark', isDark);
        toggle.setAttribute('aria-pressed', String(isDark));
        localStorage.setItem('darkMode', isDark ? '1' : '0');
      }
      setTheme(localStorage.getItem('darkMode') === '1');
      toggle.addEventListener('click', ()=> setTheme(!document.body.classList.contains('dark')));
    })();

    // Chat behavior: preset conversations and UI wiring
    (function(){
      const chatModal = document.getElementById('chatModal');
      const chatBody = document.getElementById('chatBody');
      const chatTitle = document.getElementById('chatTitle');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      const closeChat = document.getElementById('closeChat');

      // simple preset threads keyed by name (short, thematic)
      const threads = {
        'Ana Souza': [
          {from:'Ana Souza', text:'Detectamos aumento de descarte no ponto perto do c√≥rrego.'},
          {from:'Voc√™', text:'Agendamos mutir√£o para s√°bado √†s 9h. Precisamos de volunt√°rios.'}
        ],
        'Vinicius Ramos': [
          {from:'Vinicius Ramos', text:'Relat√≥rio cr√≠tico no rio. Precisamos de a√ß√£o imediata.'},
          {from:'Voc√™', text:'Acionei suporte e equipe de campo; coordenadas compartilhadas.'}
        ],
        'Carla Mendes': [
          {from:'Carla Mendes', text:'H√° muito entulho no terreno baldio da Rua das Ac√°cias.'},
          {from:'Voc√™', text:'Obrigado, vamos priorizar neste fim de semana.'}
        ]
      };

      // utility to open chat for a person
      function openChat(name){
        chatTitle.textContent = `Conversa ‚Äî ${name}`;
        chatBody.innerHTML = '';
        const list = JSON.parse(localStorage.getItem('adminThreads')||'{}');
        const thread = list[name] || threads[name] || [];
        thread.forEach(m => appendMsg(m.from, m.text));
        chatModal.setAttribute('aria-hidden','false');
        chatInput.focus();
        chatModal.dataset.current = name;
      }

      function appendMsg(from, text){
        const row = document.createElement('div');
        row.style.maxWidth = '88%';
        row.style.padding = '8px 10px';
        row.style.borderRadius = '10px';
        row.style.fontSize = '0.95rem';
        row.style.wordBreak = 'break-word';
        if(from === 'Voc√™'){
          row.style.alignSelf = 'flex-end';
          row.style.background = 'linear-gradient(180deg,#1abc9c,#16a085)';
          row.style.color = 'white';
        } else {
          row.style.alignSelf = 'flex-start';
          row.style.background = 'color-mix(in srgb, var(--card-bg) 96%, transparent)';
          row.style.border = '1px solid rgba(0,0,0,0.04)';
        }
        row.innerHTML = `<strong style="display:block;font-size:0.85rem;margin-bottom:6px">${from}</strong><div>${escapeHtml(text)}</div>`;
        chatBody.appendChild(row);
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

      // delegation: attach handler to message buttons after rendering list
      function wireMessageButtons(){
        document.querySelectorAll('.msg-btn').forEach(btn=>{
          if(btn.dataset.wired) return;
          btn.dataset.wired = '1';
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const person = btn.closest('.person').querySelector('.meta strong')?.textContent.trim();
            if(person) openChat(person);
          });
        });
      }
      // initial wiring and also after refresh button toggles
      wireMessageButtons();
      document.getElementById('refreshList').addEventListener('click', ()=> setTimeout(wireMessageButtons,120));

      chatSend.addEventListener('click', ()=>{
        const txt = chatInput.value.trim();
        if(!txt) return;
        const name = chatModal.dataset.current;
        appendMsg('Voc√™', txt);
        // persist to localStorage per person
        const all = JSON.parse(localStorage.getItem('adminThreads')||'{}');
        all[name] = all[name] || (threads[name] ? threads[name].slice() : []);
        all[name].push({from:'Voc√™', text: txt});
        localStorage.setItem('adminThreads', JSON.stringify(all));
        chatInput.value = '';
      });

      closeChat.addEventListener('click', ()=> chatModal.setAttribute('aria-hidden','true'));
      chatModal.addEventListener('click', (e)=> { if(e.target === chatModal) chatModal.setAttribute('aria-hidden','true'); });
      // re-wire after initial render and on future filter changes
      const observer = new MutationObserver(()=> wireMessageButtons());
      observer.observe(document.getElementById('managersGrid'), {childList:true, subtree:true});
      observer.observe(document.getElementById('workersGrid'), {childList:true, subtree:true});
    })();
  </script>
</body>
</html>